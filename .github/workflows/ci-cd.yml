name: CI/CD Pipeline

# DISABLED - Only manual triggering to prevent automatic runs and costs
# To re-enable, uncomment the push and pull_request triggers below
# on:
#   push:
#     branches: [ "main", "develop" ]
#   pull_request:
#     branches: [ "main", "develop" ]
on:
  workflow_dispatch:  # Only allows manual triggering

env:
  GCP_PROJECT_ID: cloud-secrets-manager
  GCP_REGION: europe-west10
  ARTIFACT_REGISTRY: europe-west10-docker.pkg.dev
  GKE_CLUSTER_DEV: cloud-secrets-cluster-dev
  GKE_CLUSTER_STAGING: cloud-secrets-cluster-staging
  GKE_CLUSTER_PROD: cloud-secrets-cluster-prod
  GKE_NAMESPACE: cloud-secrets-manager

jobs:
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build and Test Secret Service
        run: |
          cd apps/backend/secret-service
          ./mvnw clean verify
        continue-on-error: false

      - name: Build and Test Audit Service
        run: |
          cd apps/backend/audit-service
          ./mvnw clean verify
        continue-on-error: false

      - name: Generate Test Reports
        if: always()
        run: |
          cd apps/backend/secret-service
          ./mvnw surefire-report:report
          cd ../audit-service
          ./mvnw surefire-report:report

      - name: Generate JaCoCo Coverage Report
        run: |
          cd apps/backend/secret-service
          ./mvnw jacoco:report
          cd ../audit-service
          ./mvnw jacoco:report

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            apps/backend/secret-service/target/surefire-reports/
            apps/backend/audit-service/target/surefire-reports/
          retention-days: 30

      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            apps/backend/secret-service/target/site/jacoco/
            apps/backend/audit-service/target/site/jacoco/
          retention-days: 30

      - name: Coverage Summary
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f apps/backend/secret-service/target/site/jacoco/index.html ]; then
            SECRET_COVERAGE=$(grep -oP 'Total.*?(\d+)%' apps/backend/secret-service/target/site/jacoco/index.html | grep -oP '\d+' | head -1 || echo "N/A")
            echo "### Secret Service Coverage: ${SECRET_COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f apps/backend/audit-service/target/site/jacoco/index.html ]; then
            AUDIT_COVERAGE=$(grep -oP 'Total.*?(\d+)%' apps/backend/audit-service/target/site/jacoco/index.html | grep -oP '\d+' | head -1 || echo "N/A")
            echo "### Audit Service Coverage: ${AUDIT_COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full coverage reports available in artifacts" >> $GITHUB_STEP_SUMMARY

  trivy-code-scan:
    name: Trivy Code Security Scan
    runs-on: ubuntu-latest
    needs: build-test
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on critical/high vulnerabilities

      - name: Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  build-and-push-images:
    name: Build, Scan and Push Docker Images
    needs: build-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set image tags
        id: tags
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "TAG_SUFFIX=prod" >> $GITHUB_OUTPUT
            echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "TAG_SUFFIX=dev" >> $GITHUB_OUTPUT
            echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      # Build and push Secret Service
      - name: Build Secret Service Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend/secret-service
          push: false
          load: true
          platforms: linux/amd64
          tags: |
            ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/secret-service:${{ steps.tags.outputs.IMAGE_TAG }}
            ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/secret-service:${{ steps.tags.outputs.TAG_SUFFIX }}-latest
          cache-from: type=gha,scope=secret-service
          cache-to: type=gha,mode=max,scope=secret-service

      - name: Scan Secret Service Image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/secret-service:${{ steps.tags.outputs.IMAGE_TAG }}'
          format: 'sarif'
          output: 'trivy-secret-service.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on critical/high vulnerabilities

      - name: Upload Secret Service Trivy results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-secret-service.sarif'
          category: 'secret-service-image'

      - name: Push Secret Service Image
        run: |
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/secret-service:${{ steps.tags.outputs.IMAGE_TAG }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/secret-service:${{ steps.tags.outputs.TAG_SUFFIX }}-latest

      # Build and push Audit Service
      - name: Build Audit Service Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend/audit-service
          push: false
          load: true
          platforms: linux/amd64
          tags: |
            ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/audit-service:${{ steps.tags.outputs.IMAGE_TAG }}
            ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/audit-service:${{ steps.tags.outputs.TAG_SUFFIX }}-latest
          cache-from: type=gha,scope=audit-service
          cache-to: type=gha,mode=max,scope=audit-service

      - name: Scan Audit Service Image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/audit-service:${{ steps.tags.outputs.IMAGE_TAG }}'
          format: 'sarif'
          output: 'trivy-audit-service.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on critical/high vulnerabilities

      - name: Upload Audit Service Trivy results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-audit-service.sarif'
          category: 'audit-service-image'

      - name: Push Audit Service Image
        run: |
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/audit-service:${{ steps.tags.outputs.IMAGE_TAG }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/audit-service:${{ steps.tags.outputs.TAG_SUFFIX }}-latest

      - name: Generate build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Images built and pushed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images:" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Service: \`${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/secret-service:${{ steps.tags.outputs.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Audit Service: \`${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/audit-service:${{ steps.tags.outputs.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Git SHA: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY

  deploy-to-dev:
    name: Deploy to Dev Environment
    needs: build-and-push-images
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_DEV }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.13.0'

      - name: Create Artifact Registry image pull secret
        run: |
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          kubectl create secret docker-registry artifact-registry-secret \
            --docker-server=${{ env.ARTIFACT_REGISTRY }} \
            --docker-username=oauth2accesstoken \
            --docker-password="${ACCESS_TOKEN}" \
            --docker-email=github-actions-ci@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --namespace=${{ env.GKE_NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Helm
        run: |
          helm upgrade --install cloud-secrets-manager \
            ./infrastructure/helm/cloud-secrets-manager \
            --namespace ${{ env.GKE_NAMESPACE }} \
            --create-namespace \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --set image.repositorySecretService=${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/secret-service \
            --set image.repositoryAuditService=${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/audit-service \
            --timeout 10m \
            --wait

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/secret-service -n ${{ env.GKE_NAMESPACE }} --timeout=10m
          kubectl rollout status deployment/audit-service -n ${{ env.GKE_NAMESPACE }} --timeout=10m

      - name: Run smoke tests
        run: |
          ./scripts/smoke-test.sh dev

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment to Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.GKE_NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Helm Release" >> $GITHUB_STEP_SUMMARY
          helm status cloud-secrets-manager -n ${{ env.GKE_NAMESPACE }} >> $GITHUB_STEP_SUMMARY

  deploy-to-staging:
    name: Deploy to Staging Environment
    needs: build-and-push-images
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_STAGING }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.13.0'

      - name: Create Artifact Registry image pull secret
        run: |
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          kubectl create secret docker-registry artifact-registry-secret \
            --docker-server=${{ env.ARTIFACT_REGISTRY }} \
            --docker-username=oauth2accesstoken \
            --docker-password="${ACCESS_TOKEN}" \
            --docker-email=github-actions-ci@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --namespace=${{ env.GKE_NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Helm
        run: |
          helm upgrade --install cloud-secrets-manager \
            ./infrastructure/helm/cloud-secrets-manager \
            --namespace ${{ env.GKE_NAMESPACE }} \
            --create-namespace \
            --values ./infrastructure/helm/cloud-secrets-manager/values-staging.yaml \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --set image.repositorySecretService=${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/secret-service \
            --set image.repositoryAuditService=${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/audit-service \
            --timeout 10m \
            --wait

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/secret-service -n ${{ env.GKE_NAMESPACE }} --timeout=10m
          kubectl rollout status deployment/audit-service -n ${{ env.GKE_NAMESPACE }} --timeout=10m

      - name: Run smoke tests
        run: |
          ./scripts/smoke-test.sh staging

      - name: Run regression tests
        run: |
          echo "Running regression test suite..."
          # Add your regression test commands here
          # For example: newman run tests/postman/collections/regression-suite.json

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment to Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.GKE_NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Helm Release" >> $GITHUB_STEP_SUMMARY
          helm status cloud-secrets-manager -n ${{ env.GKE_NAMESPACE }} >> $GITHUB_STEP_SUMMARY

  deploy-to-production:
    name: Deploy to Production Environment
    needs: deploy-to-staging
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_PROD }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.13.0'

      - name: Create Artifact Registry image pull secret
        run: |
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          kubectl create secret docker-registry artifact-registry-secret \
            --docker-server=${{ env.ARTIFACT_REGISTRY }} \
            --docker-username=oauth2accesstoken \
            --docker-password="${ACCESS_TOKEN}" \
            --docker-email=github-actions-ci@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --namespace=${{ env.GKE_NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Backup current deployment
        run: |
          echo "Creating backup of current deployment..."
          kubectl get all -n ${{ env.GKE_NAMESPACE }} -o yaml > backup-$(date +%Y%m%d-%H%M%S).yaml

      - name: Deploy with Helm
        id: helm-deploy
        run: |
          helm upgrade --install cloud-secrets-manager \
            ./infrastructure/helm/cloud-secrets-manager \
            --namespace ${{ env.GKE_NAMESPACE }} \
            --create-namespace \
            --values ./infrastructure/helm/cloud-secrets-manager/values-production.yaml \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --set image.repositorySecretService=${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/secret-service \
            --set image.repositoryAuditService=${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/docker-images/audit-service \
            --timeout 15m \
            --wait

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/secret-service -n ${{ env.GKE_NAMESPACE }} --timeout=15m
          kubectl rollout status deployment/audit-service -n ${{ env.GKE_NAMESPACE }} --timeout=15m

      - name: Run smoke tests
        run: |
          ./scripts/smoke-test.sh production

      - name: Rollback on failure
        if: failure() && steps.helm-deploy.conclusion == 'failure'
        run: |
          echo "Deployment failed, rolling back..."
          helm rollback cloud-secrets-manager -n ${{ env.GKE_NAMESPACE }}
          kubectl rollout status deployment/secret-service -n ${{ env.GKE_NAMESPACE }} --timeout=10m
          kubectl rollout status deployment/audit-service -n ${{ env.GKE_NAMESPACE }} --timeout=10m

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.GKE_NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Helm Release" >> $GITHUB_STEP_SUMMARY
          helm status cloud-secrets-manager -n ${{ env.GKE_NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback Command (if needed)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "helm rollback cloud-secrets-manager -n ${{ env.GKE_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
