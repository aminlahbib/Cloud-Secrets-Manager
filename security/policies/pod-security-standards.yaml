---
# Pod Security Standards for Cloud Secrets Manager
# Using Pod Security Admission (replacement for deprecated PodSecurityPolicy)
# Reference: https://kubernetes.io/docs/concepts/security/pod-security-standards/

#============================================================================
# Namespace-level Pod Security Enforcement
#============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: cloud-secrets-manager
  labels:
    # Enforce restricted pod security standard (most secure)
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/enforce-version: latest
    
    # Audit violations but don't block
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/audit-version: latest
    
    # Warn on violations
    pod-security.kubernetes.io/warn: restricted
    pod-security.kubernetes.io/warn-version: latest
    
    # Custom labels
    name: cloud-secrets-manager
    environment: production

---
#============================================================================
# Security Context Constraints Documentation
#============================================================================
# The restricted standard requires all of the following:
# 
# 1. No privileged containers
# 2. No host namespaces (hostNetwork, hostPID, hostIPC)
# 3. No host ports
# 4. No privilege escalation (allowPrivilegeEscalation: false)
# 5. Must drop ALL capabilities
# 6. Must run as non-root user
# 7. seccompProfile must be RuntimeDefault or Localhost
# 8. Volumes: only allowed types (configMap, secret, emptyDir, etc.)
#============================================================================

---
# Example: Restricted Security Context for Secret Service Pod
# This should be applied in Helm templates
apiVersion: v1
kind: Pod
metadata:
  name: secret-service-example
  namespace: cloud-secrets-manager
spec:
  # Security context at pod level
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
    seccompProfile:
      type: RuntimeDefault
  
  containers:
  - name: secret-service
    image: secret-service:latest
    
    # Security context at container level
    securityContext:
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      runAsUser: 1000
      capabilities:
        drop:
          - ALL
      readOnlyRootFilesystem: true
      seccompProfile:
        type: RuntimeDefault
    
    # Resource limits (prevent resource exhaustion)
    resources:
      requests:
        memory: "256Mi"
        cpu: "200m"
      limits:
        memory: "512Mi"
        cpu: "500m"
    
    # Volume mounts (read-only where possible)
    volumeMounts:
      - name: tmp
        mountPath: /tmp
      - name: cache
        mountPath: /app/cache
  
  volumes:
    - name: tmp
      emptyDir: {}
    - name: cache
      emptyDir: {}

---
# Example: Cloud SQL Proxy Sidecar with Restricted Security Context
  - name: cloud-sql-proxy
    image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:latest
    
    securityContext:
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      runAsUser: 65532  # nonroot user
      capabilities:
        drop:
          - ALL
      readOnlyRootFilesystem: true
      seccompProfile:
        type: RuntimeDefault
    
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"

